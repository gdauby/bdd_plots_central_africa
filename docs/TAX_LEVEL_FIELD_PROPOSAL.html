<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Adding tax_level Field to table_taxa • plotsdatabase</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Adding tax_level Field to table_taxa"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">plotsdatabase</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.4</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Adding tax_level Field to table_taxa</h1>

    </div>

<div id="adding-tax_level-field-to-table_taxa" class="section level1">

<p><strong>Date</strong>: 2025-10-20 <strong>Status</strong>: Proposal - Ready to Implement</p>
<div class="section level2">
<h2 id="problem-statement">Problem Statement<a class="anchor" aria-label="anchor" href="#problem-statement"></a></h2>
<p>The <code>table_taxa</code> table currently lacks an explicit field indicating the taxonomic level of each entry. This creates several issues:</p>
<div class="section level3">
<h3 id="current-workaround-problematic">Current Workaround (Problematic)<a class="anchor" aria-label="anchor" href="#current-workaround-problematic"></a></h3>
<p>To extract genus-level taxa:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Current approach - error-prone</span></span>
<span><span class="va">genera</span> <span class="op">&lt;-</span> <span class="fu">tbl</span><span class="op">(</span><span class="va">mydb_taxa</span>, <span class="st">"table_taxa"</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">tax_gen</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">tax_esp</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>  <span class="co"># Assumes empty species = genus level</span></span>
<span>  <span class="fu">collect</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><strong>Problems with this approach:</strong> 1. <strong>Ambiguous</strong>: Empty <code>tax_esp</code> could mean missing data OR genus-level taxon 2. <strong>Fragile</strong>: Relies on data entry consistency 3. <strong>Verbose</strong>: Requires multiple conditions for each query 4. <strong>Error-prone</strong>: Easy to forget edge cases (infraspecific taxa, etc.)</p>
</div>
<div class="section level3">
<h3 id="examples-of-current-issues">Examples of Current Issues<a class="anchor" aria-label="anchor" href="#examples-of-current-issues"></a></h3>
<p><strong>Issue 1: Infraspecific taxa filtering</strong></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Want species-level only, but hard to exclude infraspecific</span></span>
<span><span class="va">species</span> <span class="op">&lt;-</span> <span class="fu">tbl</span><span class="op">(</span><span class="va">mydb_taxa</span>, <span class="st">"table_taxa"</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">tax_esp</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>  <span class="co"># Gets BOTH species AND infraspecific!</span></span>
<span>  <span class="fu">collect</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><strong>Issue 2: Genus-level filtering</strong></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Current: Need complex logic</span></span>
<span><span class="va">genera</span> <span class="op">&lt;-</span> <span class="fu">tbl</span><span class="op">(</span><span class="va">mydb_taxa</span>, <span class="st">"table_taxa"</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">tax_gen</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">tax_esp</span><span class="op">)</span>,           <span class="co"># No species</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">tax_nam01</span><span class="op">)</span>,         <span class="co"># No infraspecific 1</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">tax_nam02</span><span class="op">)</span>          <span class="co"># No infraspecific 2</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">collect</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><strong>Issue 3: Family-level filtering</strong></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Current: Need complex logic</span></span>
<span><span class="va">families</span> <span class="op">&lt;-</span> <span class="fu">tbl</span><span class="op">(</span><span class="va">mydb_taxa</span>, <span class="st">"table_taxa"</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">tax_fam</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">tax_gen</span><span class="op">)</span>,           <span class="co"># No genus</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">tax_esp</span><span class="op">)</span>,           <span class="co"># No species</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">tax_nam01</span><span class="op">)</span>,         <span class="co"># No infraspecific 1</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">tax_nam02</span><span class="op">)</span>          <span class="co"># No infraspecific 2</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">collect</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="proposed-solution">Proposed Solution<a class="anchor" aria-label="anchor" href="#proposed-solution"></a></h2>
<div class="section level3">
<h3 id="add-explicit-tax_level-field">Add Explicit <code>tax_level</code> Field<a class="anchor" aria-label="anchor" href="#add-explicit-tax_level-field"></a></h3>
<p>Add a new column to <code>table_taxa</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> table_taxa <span class="kw">ADD</span> <span class="kw">COLUMN</span> tax_level <span class="dt">VARCHAR</span>(<span class="dv">50</span>)</span></code></pre></div>
<p>Populate with one of these values: - <code>"infraspecific"</code> - Taxa with infraspecific components (variety, subspecies, etc.) - <code>"species"</code> - Species-level taxa (has genus + species epithet) - <code>"genus"</code> - Genus-level taxa (has genus only) - <code>"family"</code> - Family-level taxa (has family only) - <code>"higher"</code> - Higher taxonomic levels (order, class, phylum, etc.)</p>
</div>
<div class="section level3">
<h3 id="logic-for-population">Logic for Population<a class="anchor" aria-label="anchor" href="#logic-for-population"></a></h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="kw">UPDATE</span> table_taxa</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="kw">SET</span> tax_level <span class="op">=</span> <span class="cf">CASE</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>  <span class="cf">WHEN</span> tax_nam01 <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">AND</span> tax_nam01 <span class="op">!=</span> <span class="st">''</span> <span class="cf">THEN</span> <span class="st">'infraspecific'</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>  <span class="cf">WHEN</span> tax_nam02 <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">AND</span> tax_nam02 <span class="op">!=</span> <span class="st">''</span> <span class="cf">THEN</span> <span class="st">'infraspecific'</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>  <span class="cf">WHEN</span> tax_esp <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">AND</span> tax_esp <span class="op">!=</span> <span class="st">''</span> <span class="cf">THEN</span> <span class="st">'species'</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>  <span class="cf">WHEN</span> tax_gen <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">AND</span> tax_gen <span class="op">!=</span> <span class="st">''</span> <span class="cf">THEN</span> <span class="st">'genus'</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>  <span class="cf">WHEN</span> tax_fam <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">AND</span> tax_fam <span class="op">!=</span> <span class="st">''</span> <span class="cf">THEN</span> <span class="st">'family'</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>  <span class="cf">ELSE</span> <span class="st">'higher'</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="cf">END</span></span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="benefits">Benefits<a class="anchor" aria-label="anchor" href="#benefits"></a></h2>
<div class="section level3">
<h3 id="id_1-cleaner-queries">1. Cleaner Queries<a class="anchor" aria-label="anchor" href="#id_1-cleaner-queries"></a></h3>
<p><strong>Before</strong> (complex conditions):</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">genera</span> <span class="op">&lt;-</span> <span class="fu">tbl</span><span class="op">(</span><span class="va">mydb_taxa</span>, <span class="st">"table_taxa"</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">tax_gen</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">tax_esp</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">tax_nam01</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">tax_nam02</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">collect</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><strong>After</strong> (simple and explicit):</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">genera</span> <span class="op">&lt;-</span> <span class="fu">tbl</span><span class="op">(</span><span class="va">mydb_taxa</span>, <span class="st">"table_taxa"</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">tax_level</span> <span class="op">==</span> <span class="st">"genus"</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">collect</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_2-unambiguous-intent">2. Unambiguous Intent<a class="anchor" aria-label="anchor" href="#id_2-unambiguous-intent"></a></h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Species-level ONLY (not infraspecific)</span></span>
<span><span class="va">species</span> <span class="op">&lt;-</span> <span class="fu">tbl</span><span class="op">(</span><span class="va">mydb_taxa</span>, <span class="st">"table_taxa"</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">tax_level</span> <span class="op">==</span> <span class="st">"species"</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">collect</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Species AND infraspecific</span></span>
<span><span class="va">species_all</span> <span class="op">&lt;-</span> <span class="fu">tbl</span><span class="op">(</span><span class="va">mydb_taxa</span>, <span class="st">"table_taxa"</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">tax_level</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"species"</span>, <span class="st">"infraspecific"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">collect</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_3-better-performance-with-index">3. Better Performance with Index<a class="anchor" aria-label="anchor" href="#id_3-better-performance-with-index"></a></h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_table_taxa_tax_level <span class="kw">ON</span> table_taxa(tax_level)</span></code></pre></div>
<p>Queries filtering by <code>tax_level</code> will be faster than multi-column checks.</p>
</div>
<div class="section level3">
<h3 id="id_4-easier-data-validation">4. Easier Data Validation<a class="anchor" aria-label="anchor" href="#id_4-easier-data-validation"></a></h3>
<div class="sourceCode" id="cb11"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co">-- Find records with missing level</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> table_taxa <span class="kw">WHERE</span> tax_level <span class="kw">IS</span> <span class="kw">NULL</span>;</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="co">-- Distribution by level</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="kw">SELECT</span> tax_level, <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">FROM</span> table_taxa <span class="kw">GROUP</span> <span class="kw">BY</span> tax_level;</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_5-improved-batch-matching">5. Improved Batch Matching<a class="anchor" aria-label="anchor" href="#id_5-improved-batch-matching"></a></h3>
<p>In <code>mod_auto_matching.R</code>, the batch matching becomes cleaner:</p>
<p><strong>Before</strong>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">unique_genera</span> <span class="op">&lt;-</span> <span class="va">backbone</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">tax_gen</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">tax_esp</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>  <span class="co"># Complex</span></span>
<span>  <span class="va">...</span></span></code></pre></div>
<p><strong>After</strong>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">unique_genera</span> <span class="op">&lt;-</span> <span class="va">backbone</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">tax_level</span> <span class="op">==</span> <span class="st">"genus"</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>  <span class="co"># Clear intent</span></span>
<span>  <span class="va">...</span></span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="implementation-steps">Implementation Steps<a class="anchor" aria-label="anchor" href="#implementation-steps"></a></h2>
<div class="section level3">
<h3 id="step-1-run-the-script">Step 1: Run the Script<a class="anchor" aria-label="anchor" href="#step-1-run-the-script"></a></h3>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"add_tax_level_field.R"</span><span class="op">)</span></span></code></pre></div>
<p>This will: 1. Check if column exists 2. Add <code>tax_level</code> column to <code>table_taxa</code> 3. Populate values based on logic above 4. Create index for performance 5. Verify results with summary statistics 6. Show examples of each level 7. Test queries</p>
</div>
<div class="section level3">
<h3 id="step-2-update-batch-matching-code">Step 2: Update Batch Matching Code<a class="anchor" aria-label="anchor" href="#step-2-update-batch-matching-code"></a></h3>
<p>Replace the batch matching logic in <code>R/mod_auto_matching.R</code> with the updated version from <code>mod_auto_matching_UPDATED_with_tax_level.R</code>.</p>
<p><strong>Key changes</strong>:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># OLD (complex filtering)</span></span>
<span><span class="va">unique_genera</span> <span class="op">&lt;-</span> <span class="va">backbone</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">tax_gen_level</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">tax_esp</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="va">...</span></span>
<span></span>
<span><span class="co"># NEW (explicit level filtering)</span></span>
<span><span class="va">unique_genera</span> <span class="op">&lt;-</span> <span class="va">backbone</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">tax_level</span> <span class="op">==</span> <span class="st">"genus"</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">tax_gen_level</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="va">...</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-3-update-other-functions">Step 3: Update Other Functions<a class="anchor" aria-label="anchor" href="#step-3-update-other-functions"></a></h3>
<p>Search for similar patterns in other query functions:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="co"># Find functions using the old pattern</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="fu">grep</span> <span class="at">-r</span> <span class="st">"is.na(tax_esp)"</span> R/</span></code></pre></div>
<p>Update them to use <code>tax_level</code> field.</p>
</div>
<div class="section level3">
<h3 id="step-4-add-to-package-functions">Step 4: Add to Package Functions<a class="anchor" aria-label="anchor" href="#step-4-add-to-package-functions"></a></h3>
<p>Consider adding a helper function:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Get Taxa by Level</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' Retrieve taxa at a specific taxonomic level</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param level Character, taxonomic level: "species", "genus", "family", "infraspecific", "higher"</span></span>
<span><span class="co">#' @param unique_only Logical, return only unique names (no duplicates)</span></span>
<span><span class="co">#' @param con Database connection, defaults to call.mydb.taxa()</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return Data frame of taxa at specified level</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">get_taxa_by_level</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">level</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"species"</span>, <span class="st">"genus"</span>, <span class="st">"family"</span>, <span class="st">"infraspecific"</span>, <span class="st">"higher"</span><span class="op">)</span>,</span>
<span>                              <span class="va">unique_only</span> <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                              <span class="va">con</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="va">level</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.arg.html" class="external-link">match.arg</a></span><span class="op">(</span><span class="va">level</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">con</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/call.mydb.taxa.html">call.mydb.taxa</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html" class="external-link">dbDisconnect</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"table_taxa"</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">tax_level</span> <span class="op">==</span> <span class="op">!</span><span class="op">!</span><span class="va">level</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">unique_only</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">name_col</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span><span class="va">level</span>,</span>
<span>      <span class="st">"species"</span> <span class="op">=</span> <span class="st">"tax_esp"</span>,</span>
<span>      <span class="st">"genus"</span> <span class="op">=</span> <span class="st">"tax_gen"</span>,</span>
<span>      <span class="st">"family"</span> <span class="op">=</span> <span class="st">"tax_fam"</span>,</span>
<span>      <span class="st">"tax_gen"</span>  <span class="co"># default for infraspecific/higher</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="va">result</span> <span class="op">&lt;-</span> <span class="va">result</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/sym.html" class="external-link">sym</a></span><span class="op">(</span><span class="va">name_col</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="testing-checklist">Testing Checklist<a class="anchor" aria-label="anchor" href="#testing-checklist"></a></h2>
<p>After implementation:</p>
<div class="section level3">
<h3 id="data-integrity-tests">Data Integrity Tests<a class="anchor" aria-label="anchor" href="#data-integrity-tests"></a></h3>
<ul class="task-list"><li><label><input type="checkbox">All records have non-NULL <code>tax_level</code></label></li>
<li><label><input type="checkbox">Distribution of levels makes sense (most should be species/infraspecific)</label></li>
<li><label><input type="checkbox">No unexpected values in <code>tax_level</code> column</label></li>
<li><label><input type="checkbox">Records with <code>tax_nam01</code> are marked as “infraspecific”</label></li>
<li><label><input type="checkbox">Records with only <code>tax_gen</code> are marked as “genus”</label></li>
<li><label><input type="checkbox">Records with only <code>tax_fam</code> are marked as “family”</label></li>
</ul></div>
<div class="section level3">
<h3 id="query-tests">Query Tests<a class="anchor" aria-label="anchor" href="#query-tests"></a></h3>
<ul class="task-list"><li><label><input type="checkbox">Filter by <code>tax_level == "species"</code> returns expected records</label></li>
<li><label><input type="checkbox">Filter by <code>tax_level == "genus"</code> excludes species-level taxa</label></li>
<li><label><input type="checkbox">Filter by <code>tax_level == "family"</code> works correctly</label></li>
<li><label><input type="checkbox">Index improves query performance (compare with EXPLAIN ANALYZE)</label></li>
</ul></div>
<div class="section level3">
<h3 id="integration-tests">Integration Tests<a class="anchor" aria-label="anchor" href="#integration-tests"></a></h3>
<ul class="task-list"><li><label><input type="checkbox">Batch matching in Shiny app works with updated code</label></li>
<li><label><input type="checkbox"><code><a href="reference/query_taxa.html">query_taxa()</a></code> can use tax_level for filtering</label></li>
<li><label><input type="checkbox">Other taxonomic functions benefit from clearer queries</label></li>
</ul></div>
<div class="section level3">
<h3 id="edge-cases">Edge Cases<a class="anchor" aria-label="anchor" href="#edge-cases"></a></h3>
<ul class="task-list"><li><label><input type="checkbox">Records with missing taxonomy data handled correctly</label></li>
<li><label><input type="checkbox">Infraspecific taxa with complex ranks correctly identified</label></li>
<li><label><input type="checkbox">Higher-level taxa (order, class) marked as “higher”</label></li>
</ul><hr></div>
</div>
<div class="section level2">
<h2 id="expected-results">Expected Results<a class="anchor" aria-label="anchor" href="#expected-results"></a></h2>
<p>Running the script should show something like:</p>
<pre><code>Taxonomic Level Distribution:
─────────────────────────────────────────
tax_level       n_records  percentage
infraspecific      12,543       8.5%
species           98,234      66.3%
genus             28,456      19.2%
family             6,234       4.2%
higher             2,678       1.8%</code></pre>
<p>(Exact numbers depend on your database content)</p>
<hr></div>
<div class="section level2">
<h2 id="files-created">Files Created<a class="anchor" aria-label="anchor" href="#files-created"></a></h2>
<ol style="list-style-type: decimal"><li>
<strong><code>add_tax_level_field.R</code></strong> - Script to add and populate the field</li>
<li>
<strong><code>mod_auto_matching_UPDATED_with_tax_level.R</code></strong> - Updated batch matching code</li>
<li>
<strong><code>TAX_LEVEL_FIELD_PROPOSAL.md</code></strong> - This document</li>
</ol><hr></div>
<div class="section level2">
<h2 id="migration-notes">Migration Notes<a class="anchor" aria-label="anchor" href="#migration-notes"></a></h2>
<div class="section level3">
<h3 id="before-running">Before Running<a class="anchor" aria-label="anchor" href="#before-running"></a></h3>
<ol style="list-style-type: decimal"><li>
<p><strong>Backup the database</strong> (especially table_taxa)</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="ex">pg_dump</span> <span class="at">-U</span> username <span class="at">-t</span> table_taxa rainbio <span class="op">&gt;</span> table_taxa_backup.sql</span></code></pre></div>
</li>
<li>
<p><strong>Ensure write permissions</strong> on the taxa database</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mydb_taxa</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/call.mydb.taxa.html">call.mydb.taxa</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Should NOT show "READ-ONLY" warning</span></span></code></pre></div>
</li>
<li><p><strong>Test on a copy first</strong> if possible</p></li>
</ol></div>
<div class="section level3">
<h3 id="after-running">After Running<a class="anchor" aria-label="anchor" href="#after-running"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Verify statistics</strong> look reasonable</li>
<li>
<strong>Test a few manual queries</strong> to confirm accuracy</li>
<li>
<strong>Update application code</strong> to use the new field</li>
<li>
<strong>Remove old complex filtering patterns</strong> from codebase</li>
</ol><hr></div>
</div>
<div class="section level2">
<h2 id="rollback-plan">Rollback Plan<a class="anchor" aria-label="anchor" href="#rollback-plan"></a></h2>
<p>If needed, remove the column:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> table_taxa <span class="kw">DROP</span> <span class="kw">COLUMN</span> tax_level;</span></code></pre></div>
<p>This is safe because the original data is not modified - we only added a new column.</p>
<hr></div>
<div class="section level2">
<h2 id="future-enhancements">Future Enhancements<a class="anchor" aria-label="anchor" href="#future-enhancements"></a></h2>
<div class="section level3">
<h3 id="phase-2-add-validation-constraints">Phase 2: Add Validation Constraints<a class="anchor" aria-label="anchor" href="#phase-2-add-validation-constraints"></a></h3>
<div class="sourceCode" id="cb22"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> table_taxa</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="kw">ADD</span> <span class="kw">CONSTRAINT</span> check_tax_level</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a><span class="kw">CHECK</span> (tax_level <span class="kw">IN</span> (<span class="st">'infraspecific'</span>, <span class="st">'species'</span>, <span class="st">'genus'</span>, <span class="st">'family'</span>, <span class="st">'higher'</span>));</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="phase-3-add-trigger-for-automatic-updates">Phase 3: Add Trigger for Automatic Updates<a class="anchor" aria-label="anchor" href="#phase-3-add-trigger-for-automatic-updates"></a></h3>
<div class="sourceCode" id="cb23"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> update_tax_level()</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>RETURNS <span class="kw">TRIGGER</span> <span class="kw">AS</span> $$</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a>  <span class="kw">NEW</span>.tax_level <span class="op">:=</span> <span class="cf">CASE</span></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>    <span class="cf">WHEN</span> <span class="kw">NEW</span>.tax_nam01 <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">AND</span> <span class="kw">NEW</span>.tax_nam01 <span class="op">!=</span> <span class="st">''</span> <span class="cf">THEN</span> <span class="st">'infraspecific'</span></span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a>    <span class="cf">WHEN</span> <span class="kw">NEW</span>.tax_nam02 <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">AND</span> <span class="kw">NEW</span>.tax_nam02 <span class="op">!=</span> <span class="st">''</span> <span class="cf">THEN</span> <span class="st">'infraspecific'</span></span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a>    <span class="cf">WHEN</span> <span class="kw">NEW</span>.tax_esp <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">AND</span> <span class="kw">NEW</span>.tax_esp <span class="op">!=</span> <span class="st">''</span> <span class="cf">THEN</span> <span class="st">'species'</span></span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a>    <span class="cf">WHEN</span> <span class="kw">NEW</span>.tax_gen <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">AND</span> <span class="kw">NEW</span>.tax_gen <span class="op">!=</span> <span class="st">''</span> <span class="cf">THEN</span> <span class="st">'genus'</span></span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a>    <span class="cf">WHEN</span> <span class="kw">NEW</span>.tax_fam <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">AND</span> <span class="kw">NEW</span>.tax_fam <span class="op">!=</span> <span class="st">''</span> <span class="cf">THEN</span> <span class="st">'family'</span></span>
<span id="cb23-10"><a href="#cb23-10" tabindex="-1"></a>    <span class="cf">ELSE</span> <span class="st">'higher'</span></span>
<span id="cb23-11"><a href="#cb23-11" tabindex="-1"></a>  <span class="cf">END</span>;</span>
<span id="cb23-12"><a href="#cb23-12" tabindex="-1"></a>  <span class="kw">RETURN</span> <span class="kw">NEW</span>;</span>
<span id="cb23-13"><a href="#cb23-13" tabindex="-1"></a><span class="cf">END</span>;</span>
<span id="cb23-14"><a href="#cb23-14" tabindex="-1"></a>$$ LANGUAGE plpgsql;</span>
<span id="cb23-15"><a href="#cb23-15" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TRIGGER</span> trigger_update_tax_level</span>
<span id="cb23-17"><a href="#cb23-17" tabindex="-1"></a><span class="kw">BEFORE</span> <span class="kw">INSERT</span> <span class="kw">OR</span> <span class="kw">UPDATE</span> <span class="kw">ON</span> table_taxa</span>
<span id="cb23-18"><a href="#cb23-18" tabindex="-1"></a><span class="cf">FOR</span> <span class="kw">EACH</span> <span class="kw">ROW</span></span>
<span id="cb23-19"><a href="#cb23-19" tabindex="-1"></a><span class="kw">EXECUTE</span> <span class="kw">FUNCTION</span> update_tax_level();</span></code></pre></div>
<p>This ensures <code>tax_level</code> is always correct when taxa are added/updated.</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a></h2>
<p>Adding the <code>tax_level</code> field will:</p>
<p>✅ <strong>Simplify queries</strong> - No more complex multi-column filters ✅ <strong>Improve clarity</strong> - Explicit intent in code ✅ <strong>Boost performance</strong> - Indexed column for faster filtering ✅ <strong>Reduce errors</strong> - Less ambiguity about taxonomic levels ✅ <strong>Enable validation</strong> - Easy to spot data quality issues</p>
<p><strong>Recommendation</strong>: Implement this change. The benefits far outweigh the small implementation effort.</p>
<hr><p><strong>Next Steps</strong>: 1. Review this proposal 2. Run <code>add_tax_level_field.R</code> script 3. Verify results 4. Update <code>mod_auto_matching.R</code> with cleaner filtering 5. Gradually update other functions to use <code>tax_level</code></p>
<hr><p><strong>Author</strong>: Claude Code Assistant <strong>Date</strong>: 2025-10-20 <strong>Status</strong>: Ready to implement</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Gilles Dauby.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

